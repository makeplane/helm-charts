{{- if .Values.metrics.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ .Release.Name }}-metrics-config
  labels:
    app.kubernetes.io/name: plane-enterprise
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: metrics-agent
data:
  agent-config.yaml: |
    # OpenTelemetry Agent Configuration for Plane Enterprise
    # Collects Kubernetes metrics and Plane API metrics
    receivers:
      # Kubernetes metrics collection
      prometheus:
        config:
          global:
            scrape_interval: {{ .Values.metrics.agent.scrape_interval | default "300s" }}
            evaluation_interval: {{ .Values.metrics.agent.scrape_interval | default "300s" }}
            external_labels:
              # Multi-tenant identification
              plane_installation_uuid: "{{ include "plane.metrics.installationUUID" . }}"
              plane_installation_type: "{{ .Values.metrics.installation.type | default "kubernetes" }}"
              plane_version: "{{ .Values.metrics.installation.plane_version | default .Values.planeVersion }}"
              cluster_name: "{{ .Values.metrics.installation.cluster_name | default "default" }}"
              license_domain: "{{ .Values.license.licenseDomain }}"
          
          scrape_configs:
            # cAdvisor metrics (container resource usage for this namespace only)
            - job_name: 'kubernetes-cadvisor'
              scheme: https
              tls_config:
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                insecure_skip_verify: true
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              kubernetes_sd_configs:
                - role: node
              relabel_configs:
                - action: labelmap
                  regex: __meta_kubernetes_node_label_(.+)
                - target_label: __address__
                  replacement: kubernetes.default.svc:443
                - source_labels: [__meta_kubernetes_node_name]
                  regex: (.+)
                  target_label: __metrics_path__
                  replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
              # Filter metrics to only include containers in our namespace
              metric_relabel_configs:
                - source_labels: [namespace]
                  action: keep
                  regex: {{ .Release.Namespace }}
                - source_labels: [namespace]
                  action: drop
                  regex: ^$

            # Plane API /metrics endpoint - scrape service
            - job_name: 'plane-api'
              kubernetes_sd_configs:
                - role: service
                  namespaces:
                    names:
                      - {{ .Release.Namespace }}
              relabel_configs:
                # Only scrape the API service
                - source_labels: [__meta_kubernetes_service_name]
                  action: keep
                  regex: {{ .Release.Name }}-api
                # Set metrics path to /metrics
                - target_label: __metrics_path__
                  replacement: /metrics
                # Set port to 8000 (API service port)
                - source_labels: [__address__]
                  target_label: __address__
                  regex: ([^:]+)(?::\d+)?
                  replacement: $1:8000
                - action: labelmap
                  regex: __meta_kubernetes_service_label_(.+)
                - source_labels: [__meta_kubernetes_namespace]
                  action: replace
                  target_label: kubernetes_namespace
                - source_labels: [__meta_kubernetes_service_name]
                  action: replace
                  target_label: kubernetes_service_name

    processors:
      batch:
        timeout: {{ .Values.metrics.agent.batch.timeout | default "60s" }}
        send_batch_size: {{ .Values.metrics.agent.batch.send_batch_size | default 4096 }}
      
      memory_limiter:
        limit_mib: {{ regexReplaceAll "Mi|Gi" (.Values.metrics.agent.memoryLimit | default "256Mi") "" | int }}
        spike_limit_mib: {{ div (regexReplaceAll "Mi|Gi" (.Values.metrics.agent.memoryLimit | default "256Mi") "") 4 | int }}
        check_interval: 0.1s

      # Resource processing to add tenant identification
      resource:
        attributes:
          - key: plane.installation.uuid
            value: "{{ include "plane.metrics.installationUUID" . }}"
            action: upsert
          - key: plane.installation.type
            value: "{{ .Values.metrics.installation.type | default "kubernetes" }}"
            action: upsert
          - key: plane.installation.cluster
            value: "{{ .Values.metrics.installation.cluster_name | default "default" }}"
            action: upsert

    exporters:
      # Export to remote telemetry server  
      {{- if .Values.metrics.telemetry.http_endpoint }}
      {{- $cleanEndpoint := .Values.metrics.telemetry.http_endpoint | trimPrefix "https://" | trimPrefix "http://" | trimSuffix "/v1/traces" | trimSuffix "/v1/metrics" }}
      {{- $endpointWithPort := $cleanEndpoint }}
      {{- if not (contains ":" $cleanEndpoint) }}
        {{- $endpointWithPort = printf "%s:443" $cleanEndpoint }}
      {{- end }}
      otlp/http:
        endpoint: {{ $endpointWithPort }}
        compression: gzip
        tls:
          # TODO: Add production TLS configuration
          insecure: true
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s
        sending_queue:
          enabled: true
          num_consumers: 4
          queue_size: 100
        headers:
          {{- range $key, $value := .Values.metrics.telemetry.headers }}
          {{ $key }}: {{ $value | quote }}
          {{- end }}
      {{- end }}

      {{- if .Values.metrics.agent.debug.enabled }}
      # Debug logging (development only)
      logging:
        loglevel: debug
        sampling_initial: 5
        sampling_thereafter: 200
      {{- end }}

    extensions:
      health_check:
        endpoint: 0.0.0.0:13133
      
      pprof:
        endpoint: 0.0.0.0:1777

    service:
      extensions: [health_check, pprof]
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, resource, batch]
          exporters: [
            {{- if .Values.metrics.telemetry.http_endpoint }}otlp/http{{- if .Values.metrics.agent.debug.enabled }},{{- end }}{{- end }}
            {{- if .Values.metrics.agent.debug.enabled }}logging{{- end }}
          ]
{{- end }}

